<!DOCTYPE html>
<!-- ***********************      Tap And Map   **********************************************
**     a hardware platform to Tap an etherenet line, and Map those packets on Google Maps   **
**********************************************************************************************

This app is currently built for the Raspberry Pi V2 b.
It is designed to 'tap' two USB NICs, pull the connection information from those NICs 
(the two rightmost USB ports are bound together and traffic is sniffed and parsed from them with
custom written python sniffer code that finds public IP addresses and their geolocation information.
The Pi serves up a webserver that will dynamically 'map' this info on GoogleMaps
(RJ45 jack is the webserver, with an IP of 192.168.1.199/24, gw of 1.1 by default)

Tap takes to/from IP, protocol,and to/from port and finds the location of the public IPs
and saves this information in a log called ConnectionsSeen.txt.

Map then dynamically maps those lines, drawing lines and circles in an animated fashon  
The circles are clickable to present connection information
There is also an information windown on the right, for those who like text better than maps
Left To Do:
- make the line, circle, listner functions, vs inline calls
- Notice that below everything is part of the 'initialize' function.  Need to make DrawLine, 
  PlaceCircle, and PlaceListner all their own functions outside of this function
- read in and plot connections from the log file (vs in line below)
- change circle size depending on volume of traffic
- expire connections after a user clicks on a 'Clear Connections' button.
- allow for users to click on info in right-hand pane, and highlight that infowindow on map
- have connections scroll down the information window on the right
- Copyrite this code, Copyright/Trademark? the name (TapNMap) 
********************************************************************************************-->
<html>
<title> Tap And Map </title>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta http-equiv="Pragma" content="no-cache" />
<style type="text/css">.gm-style .gm-style-mtc label,.gm-style .gm-style-mtc div{font-weight:400}</style>
<style type="text/css">.gm-style .gm-style-cc span,.gm-style .gm-style-cc a,.gm-style .gm-style-mtc div{font-size:10px}</style>
<style type="text/css">@media print {  .gm-style .gmnoprint, .gmnoprint {    display:none  }}@media screen {  .gm-style .gmnoscreen, .gmnoscreen {    display:none  }}</style>
<style type="text/css">.gm-style{font-family:Roboto,Arial,sans-serif;font-size:11px;font-weight:400;text-decoration:none}.gm-style img{max-width:none}</style>
<style type="text/css">
html { height: 100% }
body { height: 100%; margin: 0; padding: 0 }
  #map_canvas { height: 100% }

</style>

<script src="http://maps.googleapis.com/maps/api/js?libraries=geometry&sensor=false"></script>

<script>
//var myCenter=new google.maps.LatLng(28.508742,-70.120850);
var myLocation=new google.maps.LatLng(38.00,-104); var opt = {minZoom: 2};
//var chicago = {lat: 41.85, lng: -87.65};  var opt = {minZoom: 3};


//**************** Clear_Map Function: This function clears the map of lines and recenters on home location  *********************

function CenterControl(controlDiv, map) {
  // Set CSS for the control border.
  var controlUI = document.createElement('div');
  controlUI.style.backgroundColor = '#fff';
  controlUI.style.border = '2px solid #fff';
  controlUI.style.borderRadius = '3px';
  controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)'; 
  controlUI.style.cursor = 'pointer';
  controlUI.style.marginBottom = '22px';
  controlUI.style.textAlign = 'center';
  controlUI.title = 'Click to clear map (data will remain in logs)';
  controlDiv.appendChild(controlUI);

  // Set CSS for the control interior.
  var controlText = document.createElement('div');
  controlText.style.color = 'rgb(25,25,25)';
  controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
  controlText.style.fontSize = '16px';
  controlText.style.lineHeight = '38px';
  controlText.style.paddingLeft = '5px';
  controlText.style.paddingRight = '5px';
  controlText.innerHTML = 'Clear Map';
  controlUI.appendChild(controlText);

  // Setup the click event listeners.
  controlUI.addEventListener('click', function() {
    map.setCenter(myLocation);
    window.open("http://10.50.60.18/cgi-bin/ResetScreen.sh", '_blank');
  });
}    //  *****************************  End of Clear_Map Function  ****************************

//**************** Clear PacketText Function: This function clears the packets text in the right pane *********************
function RightControl(controlDiv, map) {
  // Set CSS for the control border.
  var controlRT = document.createElement('div');
  controlRT.style.backgroundColor = '#fff';
  controlRT.style.border = '2px solid #fff';
  controlRT.style.borderRadius = '3px';
  controlRT.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)'; 
  controlRT.style.cursor = 'pointer';
  controlRT.style.marginBottom = '22px';
  controlRT.style.marginTop = '0px';
  controlRT.style.textAlign = 'center';
  controlRT.title = 'Click to clear map (data will remain in logs)';
  controlDiv.appendChild(controlRT);

  // Set CSS for the control interior.
  var controlText2 = document.createElement('div');
  controlText2.style.color = 'rgb(25,25,25)';
  controlText2.style.fontFamily = 'Roboto,Arial,sans-serif';
  controlText2.style.fontSize = '16px';
  controlText2.style.lineHeight = '38px';
  controlText2.style.paddingLeft = '5px';
  controlText2.style.paddingRight = '5px';
  controlText2.innerHTML = 'Clear Text';
  controlRT.appendChild(controlText2);

  // Setup the click event listeners.
  controlRT.addEventListener('click', function() {
    map.setCenter(myLocation);
    window.open("http://10.50.60.18/cgi-bin/ResetText.sh", '_blank');
  });
}    //  *****************************  End of Clear_Map Function  ****************************


function initialize() {
  var mapProp = {
    center:myLocation,
    zoom:3,
    mapTypeId:google.maps.MapTypeId.ROADMAP
    };

  var map=new google.maps.Map(document.getElementById("googleMap"),mapProp);
  map.data.setStyle({});                // This setStyle oesn't seem to do anything... Need to figure out a way to make the styles (color, line width, etc) change.  
  map.data.setStyle({
    //icon: '//example.com/path/to/image.png',
    strokeColor: "green",
    strokeOpacity: 1,
    strokeWeight: 3,
    geodesic: true //set to false if you want straight line instead of arc
    });

// The below will load the datafile every second (1000ms)
//  setInterval(function() {              // *********************  Add me back for real-time updates  *************************8
     // load in the file of GeoJSON markers made by the sniffer (with lines from the current location)
  map.data.loadGeoJson('Connections_Seen.json');
  map.data.setStyle(function(feature) {
    return /** @type {google.maps.Data.StyleOptions} */({
      strokeColor: feature.getProperty('color'),
      strokeWeight: 3,
      geodesic: true
      });
  });  

  // global infowindow
  var infowindow = new google.maps.InfoWindow();

  // When the user clicks, open an infowindow
  map.data.addListener('click', function(event) {
      var myHTML = event.feature.getProperty("description");
      infowindow.setContent("<div style='width:300px; text-align: center;'>"+myHTML+"</div>");
      infowindow.setPosition(event.feature.getGeometry().get());
      infowindow.setOptions({pixelOffset: new google.maps.Size(0,-30)});
      infowindow.open(map);
      }); 
  map.setOptions(opt);
//  }, 1000);        // **************************  Add me back for real-time updates **********************8

// Create the DIV to hold the control and call the CenterControl()
  // constructor passing in this DIV.
  var centerControlDiv = document.createElement('div');
  var centerControl = new CenterControl(centerControlDiv, map);

  centerControlDiv.index = 1;
  map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);

  var rightControlDiv = document.createElement('div');
  var rightControl = new RightControl(rightControlDiv, map);

  rightControlDiv.index = 1;
  map.controls[google.maps.ControlPosition.TOP_CENTER].push(rightControlDiv);

}  ///////////////////  this is the end of the initialize fuction  //////////////////

google.maps.event.addDomListener(window, 'load', initialize);

</script>
</head>

<body>

<div id="googleMap" style="width:75%;float:left;height: 100%;"></div>

<div id="Right">
    <iframe src="right.html" style="position:absolute;width:24.8%;float:right;height:99.6%;"></iframe>
    </div>
</body>

</html> 

